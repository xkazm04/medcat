---
phase: 06-bulk-import
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/utils/csv-parser.ts
  - src/lib/schemas/import.ts
autonomous: true

must_haves:
  truths:
    - "PapaParse is installed and available for import"
    - "CSV files can be parsed with TypeScript type safety"
    - "Column mapping schema validates required fields"
  artifacts:
    - path: "src/lib/utils/csv-parser.ts"
      provides: "CSV parsing with preview and full parse modes"
      exports: ["parseCSVPreview", "parseCSVFull", "CSVRow", "ParseResult"]
    - path: "src/lib/schemas/import.ts"
      provides: "Zod schemas for column mapping and row validation"
      exports: ["columnMappingSchema", "importRowSchema", "MAPPABLE_FIELDS"]
  key_links:
    - from: "src/lib/utils/csv-parser.ts"
      to: "papaparse"
      via: "import Papa from 'papaparse'"
      pattern: "import.*Papa.*from.*papaparse"
---

<objective>
Install PapaParse and create foundation utilities for CSV import.

Purpose: Establish the parsing infrastructure and validation schemas that all import components will use.
Output: CSV parser utility with TypeScript types, Zod schemas for column mapping and row validation.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-bulk-import/06-RESEARCH.md
@src/lib/schemas/product.ts
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PapaParse and create CSV parser utility</name>
  <files>package.json, src/lib/utils/csv-parser.ts</files>
  <action>
1. Install PapaParse with TypeScript types:
   ```bash
   npm install papaparse @types/papaparse
   ```

2. Create `src/lib/utils/csv-parser.ts` with:
   - `CSVRow` interface: `{ [key: string]: string }`
   - `ParseResult` interface with `data: CSVRow[]`, `headers: string[]`, `errors: Papa.ParseError[]`, `totalRows: number`
   - `parseCSVPreview(file: File, previewRows?: number)`: Returns Promise<ParseResult> with only first N rows (default 10) for preview. Use Papa.parse with `header: true`, `skipEmptyLines: true`, `preview: previewRows`.
   - `parseCSVFull(file: File)`: Returns Promise<ParseResult> with all rows. Same options but no preview limit.

Both functions should handle BOM (PapaParse strips automatically) and use UTF-8 encoding.

Export all types and functions.
  </action>
  <verify>
  - `npm ls papaparse` shows papaparse installed
  - File exists at src/lib/utils/csv-parser.ts
  - TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>PapaParse installed, csv-parser.ts exports parseCSVPreview, parseCSVFull, CSVRow, ParseResult</done>
</task>

<task type="auto">
  <name>Task 2: Create import validation schemas</name>
  <files>src/lib/schemas/import.ts</files>
  <action>
Create `src/lib/schemas/import.ts` with:

1. `MAPPABLE_FIELDS` constant array defining product fields that can be mapped from CSV:
   ```typescript
   export const MAPPABLE_FIELDS = [
     { key: 'name', label: 'Product Name', required: true },
     { key: 'sku', label: 'SKU', required: true },
     { key: 'description', label: 'Description', required: false },
     { key: 'price', label: 'Price', required: false },
     { key: 'vendor_id', label: 'Vendor', required: false },
     { key: 'manufacturer_name', label: 'Manufacturer', required: false },
     { key: 'manufacturer_sku', label: 'Manufacturer SKU', required: false },
   ] as const;
   ```

2. `columnMappingSchema` - Zod schema for validating column mapping configuration:
   - name: z.string().min(1, 'Name column is required')
   - sku: z.string().min(1, 'SKU column is required')
   - description: z.string().optional()
   - price: z.string().optional()
   - vendor_id: z.string().optional()
   - manufacturer_name: z.string().optional()
   - manufacturer_sku: z.string().optional()

3. `importRowSchema` - Zod schema for validating a single import row (based on productSchema but with _rowIndex):
   - Extend from productSchema (import from @/lib/schemas/product)
   - Add `_rowIndex: z.number()` for error reporting
   - Make vendor_id optional (will be set at import time)
   - Make emdn_category_id, material_id, udi_di, mdr_class optional (not in CSV)

4. Export types: `ColumnMapping`, `ImportRow`, `MappableField`
  </action>
  <verify>
  - File exists at src/lib/schemas/import.ts
  - TypeScript compiles without errors: `npx tsc --noEmit`
  - Schemas can be imported and used
  </verify>
  <done>import.ts exports MAPPABLE_FIELDS, columnMappingSchema, importRowSchema with correct validation rules</done>
</task>

</tasks>

<verification>
1. `npm ls papaparse` shows version ^5.4.x
2. Both files exist and compile: `npx tsc --noEmit`
3. Can import from both modules without errors
</verification>

<success_criteria>
- PapaParse ^5.4.x installed with @types/papaparse
- csv-parser.ts provides parseCSVPreview and parseCSVFull functions
- import.ts provides MAPPABLE_FIELDS, columnMappingSchema, importRowSchema
- All TypeScript types are properly exported
- No compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-bulk-import/06-01-SUMMARY.md`
</output>
