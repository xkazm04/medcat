---
phase: 06-bulk-import
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/actions/import.ts
  - src/components/import/file-upload-step.tsx
autonomous: true

must_haves:
  truths:
    - "Server action can import products with deduplication by SKU+vendor"
    - "Import returns counts of created, updated, skipped products"
    - "File upload component accepts CSV files with drag-drop"
    - "Upload triggers parsing and shows file name"
  artifacts:
    - path: "src/lib/actions/import.ts"
      provides: "Server action for batch product import with deduplication"
      exports: ["importProducts", "checkExistingProducts", "ImportResult"]
    - path: "src/components/import/file-upload-step.tsx"
      provides: "CSV file upload with drag-drop and validation"
      exports: ["FileUploadStep"]
  key_links:
    - from: "src/lib/actions/import.ts"
      to: "src/lib/supabase/server.ts"
      via: "createClient import"
      pattern: "import.*createClient.*from.*supabase/server"
    - from: "src/lib/actions/import.ts"
      to: "src/lib/schemas/import.ts"
      via: "importRowSchema import"
      pattern: "import.*importRowSchema.*from.*schemas/import"
    - from: "src/components/import/file-upload-step.tsx"
      to: "src/lib/utils/csv-parser.ts"
      via: "parseCSVPreview import"
      pattern: "import.*parseCSVPreview.*from.*csv-parser"
---

<objective>
Create the import server action and file upload component.

Purpose: Enable batch product import with SKU-based deduplication and provide the first step of the import wizard.
Output: Server action that handles import logic, upload component that parses CSV and passes data to parent.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-bulk-import/06-RESEARCH.md
@.planning/phases/06-bulk-import/06-01-SUMMARY.md
@src/lib/schemas/product.ts
@src/lib/schemas/import.ts
@src/lib/actions/products.ts
@src/lib/utils/csv-parser.ts
@src/components/extraction/upload-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create import server action with deduplication</name>
  <files>src/lib/actions/import.ts</files>
  <action>
Create `src/lib/actions/import.ts` with:

1. `ImportResult` interface:
   ```typescript
   export interface ImportResult {
     created: number;
     updated: number;
     skipped: number;
     errors: Array<{ row: number; field: string; message: string }>;
   }
   ```

2. `checkExistingProducts(skus: string[], vendorId: string)` function:
   - Query products table for existing SKUs with matching vendor_id
   - Return Map<string, string> of sku -> product_id for existing products
   - Used for showing "will update" warning before import

3. `importProducts(rows: unknown[], vendorId: string)` server action:
   - Add 'use server' directive
   - Accept array of mapped row objects and vendorId
   - Process in batches of 100 (BATCH_SIZE constant)
   - For each row:
     a. Validate with importRowSchema.safeParse()
     b. If invalid, add to errors with row index, field, message, increment skipped
     c. If valid, check if product exists by (sku + vendor_id)
     d. If exists: update product, increment updated
     e. If not exists: insert product, increment created
   - Call revalidatePath('/') after all operations
   - Return ImportResult

Important: SKU is not unique globally - same SKU can exist from different vendors. Deduplication is by (sku + vendor_id) pair.

Follow existing patterns from src/lib/actions/products.ts for Supabase client usage and error handling.
  </action>
  <verify>
  - File exists at src/lib/actions/import.ts
  - TypeScript compiles: `npx tsc --noEmit`
  - Exports importProducts, checkExistingProducts, ImportResult
  </verify>
  <done>import.ts server action handles batch import with SKU+vendor deduplication, returns created/updated/skipped counts</done>
</task>

<task type="auto">
  <name>Task 2: Create file upload step component</name>
  <files>src/components/import/file-upload-step.tsx</files>
  <action>
Create `src/components/import/file-upload-step.tsx`:

1. Props interface:
   ```typescript
   interface FileUploadStepProps {
     onFileSelect: (file: File, headers: string[], preview: CSVRow[]) => void;
     onClear: () => void;
     selectedFile: File | null;
   }
   ```

2. Component features:
   - 'use client' directive
   - Drag-drop zone with border-dashed styling (follow extraction/upload-form.tsx pattern)
   - Accept only .csv files (accept=".csv,text/csv")
   - On file select or drop:
     a. Validate it's a CSV file
     b. Call parseCSVPreview() from csv-parser.ts
     c. Pass file, headers, and preview rows to onFileSelect callback
   - Display selected file name with FileSpreadsheet icon
   - Clear button (X icon) to remove selection and call onClear
   - Show parsing errors if any

3. Styling:
   - Use Tailwind classes matching project style
   - Import icons from lucide-react: Upload, FileSpreadsheet, X, Loader2
   - Show loading spinner during parsing

Export as named export: `FileUploadStep`
  </action>
  <verify>
  - File exists at src/components/import/file-upload-step.tsx
  - TypeScript compiles: `npx tsc --noEmit`
  - Component exports FileUploadStep
  </verify>
  <done>FileUploadStep component handles CSV file selection with drag-drop, parses preview, and reports headers/data to parent</done>
</task>

</tasks>

<verification>
1. Both files exist and compile: `npx tsc --noEmit`
2. Server action exports importProducts, checkExistingProducts
3. Component exports FileUploadStep
4. No linting errors
</verification>

<success_criteria>
- importProducts handles batch import with deduplication by SKU+vendor_id
- Import returns accurate created/updated/skipped/errors counts
- FileUploadStep accepts CSV via click or drag-drop
- File parsing happens on selection, headers and preview passed to parent
- Both follow existing codebase patterns
</success_criteria>

<output>
After completion, create `.planning/phases/06-bulk-import/06-02-SUMMARY.md`
</output>
