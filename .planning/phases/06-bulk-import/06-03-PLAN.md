---
phase: 06-bulk-import
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/components/import/column-mapping-step.tsx
  - src/components/import/validation-step.tsx
autonomous: true

must_haves:
  truths:
    - "User can map CSV columns to product fields via dropdowns"
    - "Required fields (name, sku) show validation error if unmapped"
    - "Validation preview shows row-level errors with highlighting"
    - "User can see which rows will be created vs updated"
  artifacts:
    - path: "src/components/import/column-mapping-step.tsx"
      provides: "Column mapping interface with dropdowns"
      exports: ["ColumnMappingStep"]
    - path: "src/components/import/validation-step.tsx"
      provides: "Validation preview with error highlighting and duplicate detection"
      exports: ["ValidationStep"]
  key_links:
    - from: "src/components/import/column-mapping-step.tsx"
      to: "src/lib/schemas/import.ts"
      via: "MAPPABLE_FIELDS import"
      pattern: "import.*MAPPABLE_FIELDS.*from.*schemas/import"
    - from: "src/components/import/validation-step.tsx"
      to: "src/lib/actions/import.ts"
      via: "checkExistingProducts import"
      pattern: "import.*checkExistingProducts.*from.*actions/import"
---

<objective>
Create the column mapping and validation step components.

Purpose: Enable users to map CSV columns to product fields and preview validation results before import.
Output: Column mapping component with field dropdowns, validation step with error highlighting and duplicate warnings.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-bulk-import/06-RESEARCH.md
@.planning/phases/06-bulk-import/06-02-SUMMARY.md
@src/lib/schemas/import.ts
@src/lib/actions/import.ts
@src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create column mapping step component</name>
  <files>src/components/import/column-mapping-step.tsx</files>
  <action>
Create `src/components/import/column-mapping-step.tsx`:

1. Props interface:
   ```typescript
   interface ColumnMappingStepProps {
     headers: string[];  // CSV column headers from parse
     mapping: Record<string, string>;  // productField -> csvColumn
     onMappingChange: (mapping: Record<string, string>) => void;
     previewData: CSVRow[];  // First few rows for preview
   }
   ```

2. Component layout:
   - 'use client' directive
   - Two-column layout: left shows product fields, right shows CSV column dropdown
   - For each field in MAPPABLE_FIELDS:
     a. Label with field name (mark required with red asterisk)
     b. Select dropdown with headers as options plus "-- Not mapped --" option
     c. If field is required and not mapped, show error styling
   - Preview table below showing 3-5 sample rows with mapped values

3. Mapping logic:
   - Auto-detect: On mount, try to auto-map columns by matching header names (case-insensitive):
     - "name", "product name", "product_name" -> name
     - "sku", "product sku", "item code" -> sku
     - "description", "desc" -> description
     - "price", "unit price", "cost" -> price
     - "manufacturer", "manufacturer name", "mfr" -> manufacturer_name
     - "manufacturer sku", "mfr sku", "mfr_sku" -> manufacturer_sku
   - Call onMappingChange with initial auto-mapping

4. Styling:
   - Use existing form styling patterns
   - Required fields marked visually
   - Preview table with striped rows

Export as named export: `ColumnMappingStep`
  </action>
  <verify>
  - File exists at src/components/import/column-mapping-step.tsx
  - TypeScript compiles: `npx tsc --noEmit`
  - Component exports ColumnMappingStep
  </verify>
  <done>ColumnMappingStep provides dropdown mapping from CSV columns to product fields with auto-detection and preview</done>
</task>

<task type="auto">
  <name>Task 2: Create validation step component</name>
  <files>src/components/import/validation-step.tsx</files>
  <action>
Create `src/components/import/validation-step.tsx`:

1. Props interface:
   ```typescript
   interface ValidationStepProps {
     data: CSVRow[];  // Full parsed CSV data
     mapping: Record<string, string>;  // productField -> csvColumn
     vendorId: string;  // Selected vendor for deduplication check
     onValidationComplete: (validRows: ImportRow[], existingCount: number) => void;
   }
   ```

2. Component behavior:
   - 'use client' directive
   - On mount/data change, run validation:
     a. Map each CSV row to product fields using mapping
     b. Validate each mapped row with importRowSchema
     c. Check for existing products using checkExistingProducts()
   - Store validation state: validRows, invalidRows, existingSkus

3. Display:
   - Summary stats at top:
     - "X rows ready to import"
     - "Y rows will update existing products" (with warning icon)
     - "Z rows have errors" (with error icon)
   - Scrollable table showing all rows with status column:
     - Green checkmark for valid new rows
     - Yellow update icon for existing SKUs
     - Red X for invalid rows
   - Error rows expanded to show field-level error messages
   - Highlight cells with validation errors in red

4. Actions:
   - Call onValidationComplete with valid rows and existing count when validation finishes
   - "Continue" should only be enabled when at least one valid row exists

5. Loading state:
   - Show spinner while checking existing products (async operation)

Export as named export: `ValidationStep`
  </action>
  <verify>
  - File exists at src/components/import/validation-step.tsx
  - TypeScript compiles: `npx tsc --noEmit`
  - Component exports ValidationStep
  </verify>
  <done>ValidationStep shows row-level validation, highlights errors, warns about duplicates, and reports valid rows to parent</done>
</task>

</tasks>

<verification>
1. Both files exist and compile: `npx tsc --noEmit`
2. ColumnMappingStep provides mapping interface with auto-detection
3. ValidationStep shows validation results with duplicate warnings
4. No linting errors
</verification>

<success_criteria>
- Column mapping shows all MAPPABLE_FIELDS with dropdown selectors
- Auto-detection maps common column names on mount
- Required fields show error if unmapped
- Validation step shows per-row status (valid/update/error)
- Existing SKUs detected and counted with warning display
- Error messages shown at field level with cell highlighting
</success_criteria>

<output>
After completion, create `.planning/phases/06-bulk-import/06-03-SUMMARY.md`
</output>
