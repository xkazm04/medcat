---
phase: 02-product-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/types.ts
  - src/lib/schemas/product.ts
  - src/lib/actions/products.ts
  - supabase/migrations/002_regulatory_fields.sql
autonomous: true

must_haves:
  truths:
    - "New dependencies installed and importable"
    - "Product type includes regulatory fields"
    - "Zod schema validates product data"
    - "Server actions can update and delete products"
  artifacts:
    - path: "src/lib/schemas/product.ts"
      provides: "Zod validation schema"
      exports: ["productSchema", "ProductFormData"]
    - path: "src/lib/actions/products.ts"
      provides: "Server mutations"
      exports: ["updateProduct", "deleteProduct"]
    - path: "supabase/migrations/002_regulatory_fields.sql"
      provides: "Database migration for regulatory fields"
      contains: "udi_di"
  key_links:
    - from: "src/lib/actions/products.ts"
      to: "src/lib/schemas/product.ts"
      via: "import productSchema"
      pattern: "import.*productSchema.*from"
---

<objective>
Install Phase 2 dependencies, extend types with regulatory fields, create Zod validation schema and Server Actions for product CRUD operations.

Purpose: Foundation for all product management features - validation, mutations, and extended data model
Output: Working Server Actions, shared schema, migration file, updated types
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-product-management/02-RESEARCH.md
@src/lib/types.ts
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and update types</name>
  <files>package.json, src/lib/types.ts</files>
  <action>
1. Install new dependencies:
   ```bash
   npm install @radix-ui/react-dialog @radix-ui/react-alert-dialog react-hook-form @hookform/resolvers zod
   ```

2. Update src/lib/types.ts - add regulatory fields to Product interface:
   - udi_di: string | null (UDI-DI identifier, max 14 chars)
   - ce_marked: boolean (CE marking status)
   - mdr_class: 'I' | 'IIa' | 'IIb' | 'III' | null (MDR risk classification)

3. Also update ProductWithRelations to include the new fields (they inherit from Product)

Note: Keep existing fields unchanged, only ADD the new regulatory fields.
  </action>
  <verify>
    - npm ls @radix-ui/react-dialog (shows installed)
    - npm ls zod (shows installed)
    - TypeScript compiles: npx tsc --noEmit
  </verify>
  <done>All dependencies installed, Product type includes udi_di, ce_marked, mdr_class fields</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod schema and Server Actions</name>
  <files>src/lib/schemas/product.ts, src/lib/actions/products.ts</files>
  <action>
1. Create src/lib/schemas/product.ts:
   - Define productSchema with Zod:
     - name: string, required, min 1, max 255
     - sku: string, required, min 1, max 50
     - description: string, max 2000, nullable
     - price: coerce to number, positive, nullable
     - vendor_id: string uuid, nullable
     - emdn_category_id: string uuid, nullable
     - material_id: string uuid, nullable
     - udi_di: string, max 14, nullable
     - ce_marked: boolean, default false
     - mdr_class: enum ['I', 'IIa', 'IIb', 'III'], nullable
   - Export ProductFormData type (z.infer of schema)

2. Create src/lib/actions/products.ts:
   - Mark 'use server' at top
   - Import createClient from @/lib/supabase/server
   - Import revalidatePath from next/cache
   - Import productSchema from @/lib/schemas/product

   updateProduct(id: string, formData: FormData):
   - Convert FormData to object using Object.fromEntries
   - Handle boolean ce_marked (formData returns string "true"/"false")
   - Parse with productSchema.safeParse
   - If invalid, return { error: validatedData.error.flatten() }
   - Update product in Supabase
   - Call revalidatePath('/')
   - Return { success: true } or { error: { formErrors: [message] } }

   deleteProduct(id: string):
   - Delete from products table where id matches
   - Call revalidatePath('/')
   - Return { success: true } or { error: message }
  </action>
  <verify>
    - npx tsc --noEmit (no type errors)
    - File exists: ls src/lib/schemas/product.ts
    - File exists: ls src/lib/actions/products.ts
  </verify>
  <done>Zod schema exports productSchema and ProductFormData, Server Actions export updateProduct and deleteProduct</done>
</task>

<task type="auto">
  <name>Task 3: Create database migration file</name>
  <files>supabase/migrations/002_regulatory_fields.sql</files>
  <action>
1. Create supabase/migrations directory if it doesn't exist

2. Create 002_regulatory_fields.sql with:
   ```sql
   -- Migration: Add regulatory fields to products table
   -- Run this in Supabase SQL Editor

   -- Add regulatory columns
   ALTER TABLE products
   ADD COLUMN IF NOT EXISTS udi_di VARCHAR(14),
   ADD COLUMN IF NOT EXISTS ce_marked BOOLEAN DEFAULT false,
   ADD COLUMN IF NOT EXISTS mdr_class VARCHAR(3) CHECK (mdr_class IN ('I', 'IIa', 'IIb', 'III') OR mdr_class IS NULL);

   -- Add index for UDI-DI lookups (useful for duplicate detection later)
   CREATE INDEX IF NOT EXISTS idx_products_udi ON products(udi_di) WHERE udi_di IS NOT NULL;

   -- Add RLS policies for write operations
   -- Permissive for now (no auth required) - will be tightened when auth is added
   DROP POLICY IF EXISTS "Allow all updates" ON products;
   DROP POLICY IF EXISTS "Allow all deletes" ON products;

   CREATE POLICY "Allow all updates" ON products FOR UPDATE USING (true);
   CREATE POLICY "Allow all deletes" ON products FOR DELETE USING (true);

   -- Verify
   SELECT column_name, data_type, character_maximum_length
   FROM information_schema.columns
   WHERE table_name = 'products'
   AND column_name IN ('udi_di', 'ce_marked', 'mdr_class');
   ```

Note: This migration must be run manually in Supabase SQL Editor (Supabase CLI not configured).
  </action>
  <verify>
    - File exists: ls supabase/migrations/002_regulatory_fields.sql
    - Contains ALTER TABLE: grep "ALTER TABLE" supabase/migrations/002_regulatory_fields.sql
  </verify>
  <done>Migration file created with regulatory columns, index, and RLS policies</done>
</task>

</tasks>

<verification>
1. All dependencies installed: `npm ls @radix-ui/react-dialog zod react-hook-form @hookform/resolvers`
2. TypeScript compiles: `npx tsc --noEmit`
3. Schema file exports: grep "export" src/lib/schemas/product.ts
4. Actions file exports: grep "export async" src/lib/actions/products.ts
5. Migration file ready for Supabase SQL Editor
</verification>

<success_criteria>
- Dependencies installed without errors
- Product type includes udi_di, ce_marked, mdr_class
- productSchema validates all fields with proper constraints
- updateProduct and deleteProduct Server Actions implemented
- Migration SQL file ready for manual execution
</success_criteria>

<output>
After completion, create `.planning/phases/02-product-management/02-01-SUMMARY.md`
</output>
