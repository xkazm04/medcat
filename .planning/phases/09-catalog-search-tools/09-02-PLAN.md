---
phase: 09-catalog-search-tools
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/chat/product-card.tsx
  - src/components/chat/comparison-table.tsx
  - src/components/chat/category-chips.tsx
  - src/components/chat/loading-spinner.tsx
  - src/components/chat/message-list.tsx
  - src/components/chat/chat-panel.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can see product cards in chat when AI searches catalog"
    - "Product cards show name, price, vendor in compact view"
    - "Product cards expand to show SKU, material, EMDN on click"
    - "User can click 'Compare prices' on card and see comparison table"
    - "Price comparison shows as text for single vendor, table for multiple"
    - "EMDN category chips appear for ambiguous queries"
    - "User can click category chip to search within that category"
    - "Loading spinner shows while tool executes"
  artifacts:
    - path: "src/components/chat/product-card.tsx"
      provides: "Compact/expandable product card with action buttons"
      exports: ["ProductCard"]
    - path: "src/components/chat/comparison-table.tsx"
      provides: "Price comparison table sorted by price"
      exports: ["ComparisonTable"]
    - path: "src/components/chat/category-chips.tsx"
      provides: "Clickable EMDN category suggestion chips"
      exports: ["CategoryChips"]
    - path: "src/components/chat/loading-spinner.tsx"
      provides: "Tool loading indicator"
      exports: ["LoadingSpinner"]
    - path: "src/components/chat/message-list.tsx"
      provides: "Tool part rendering via switch-case"
      contains: "tool-searchProducts"
  key_links:
    - from: "src/components/chat/message-list.tsx"
      to: "src/components/chat/product-card.tsx"
      via: "ProductCard import and render in tool-searchProducts case"
      pattern: "ProductCard"
    - from: "src/components/chat/message-list.tsx"
      to: "src/components/chat/comparison-table.tsx"
      via: "ComparisonTable import and render in tool-comparePrices case"
      pattern: "ComparisonTable"
    - from: "src/components/chat/category-chips.tsx"
      to: "sendMessage"
      via: "onSelect callback triggers new search message"
      pattern: "sendMessage"
---

<objective>
Create UI components for rendering tool results in chat: product cards, comparison tables, and category chips.

Purpose: Transform raw tool output into visual, interactive elements that let users browse products, compare prices, and refine searches without leaving the chat interface.

Output: Four new components (ProductCard, ComparisonTable, CategoryChips, LoadingSpinner) integrated into MessageList for automatic tool result rendering.
</objective>

<execution_context>
@C:\Users\mkdol\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\mkdol\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-catalog-search-tools/09-RESEARCH.md
@.planning/phases/09-catalog-search-tools/09-CONTEXT.md
@src/components/chat/message-list.tsx
@src/components/chat/chat-panel.tsx
@src/lib/types.ts
@src/lib/utils/format-price.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tool result UI components</name>
  <files>src/components/chat/product-card.tsx, src/components/chat/comparison-table.tsx, src/components/chat/category-chips.tsx, src/components/chat/loading-spinner.tsx</files>
  <action>
Create four new components in `src/components/chat/`:

**loading-spinner.tsx:**
- Props: { text: string }
- Render: Loader2 icon from lucide-react with animate-spin + text
- Use muted-foreground color, text-sm size
- Reference RESEARCH.md "Loading State Component"

**product-card.tsx:**
- Props: { product: ProductWithRelations, onCompare: (id) => void, onViewInCatalog: (id) => void }
- State: expanded (boolean, default false)
- Compact view: name, price (via formatPrice with 'en' locale), vendor name
- Expand button: ChevronDown icon that rotates 180deg when expanded
- Expanded view (Motion animate): SKU, material name, EMDN code
- Action buttons: "Compare prices", "View in catalog" (both text-xs, bg-muted hover style)
- Use motion.div with layout prop for smooth expand/collapse
- Import AnimatePresence from 'motion'
- Reference RESEARCH.md Pattern 4 code example

**comparison-table.tsx:**
- Props: { products: ProductPriceComparison[] } (import type from lib/actions/similarity)
- Single vendor (length === 1): render as plain text "Available from [Vendor] at [Price]"
- Multiple vendors: render table with columns Vendor, Price, SKU
- Sort products by price ascending before render
- Use formatPrice with 'en' locale for price column
- Table styling: text-xs, borders, bg-muted header, hover:bg-muted/50 rows
- Reference RESEARCH.md "Comparison Table Component"

**category-chips.tsx:**
- Props: { suggestions: Array<{id, code, name, count}>, onSelect: (categoryId, categoryName) => void }
- Empty suggestions: show "No category suggestions available"
- Render intro text: "Your search is broad. Select a category to narrow results:"
- Render chips as buttons: rounded-full, bg-muted, hover:bg-accent
- Each chip shows category name + count in parentheses
- onClick calls onSelect(cat.id, cat.name)
- Reference RESEARCH.md "Category Chips Component"

All components: 'use client' directive, export named component.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/components/chat/*.tsx`
All components export correctly: `grep "export function" src/components/chat/product-card.tsx src/components/chat/comparison-table.tsx src/components/chat/category-chips.tsx src/components/chat/loading-spinner.tsx`
  </verify>
  <done>
Four tool rendering components exist with correct props interfaces, styling per CONTEXT.md decisions, and interactive behaviors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MessageList to render tool parts</name>
  <files>src/components/chat/message-list.tsx</files>
  <action>
Update `src/components/chat/message-list.tsx` to render tool results:

**Add imports:**
- ProductCard, ComparisonTable, CategoryChips, LoadingSpinner from ./
- ProductWithRelations from @/lib/types
- ProductPriceComparison from @/lib/actions/similarity

**Add props:**
- Add `onComparePrice: (productId: string) => void` prop
- Add `onCategorySelect: (categoryId: string, categoryName: string) => void` prop
- Add `onViewInCatalog: (productId: string) => void` prop

**Refactor message rendering to part-based iteration:**
Keep MessageBubble for text parts. Change the rendering pattern from:

```tsx
// OLD: Single bubble per message
messages.map(msg => <MessageBubble content={getMessageText(msg)} role={msg.role} />)
```

To:

```tsx
// NEW: Iterate over parts, use MessageBubble for text, custom components for tools
messages.map(msg => (
  <div key={msg.id}>
    {msg.parts.map((part, partIndex) => {
      switch (part.type) {
        case 'text':
          return <MessageBubble key={partIndex} content={part.text} role={msg.role} />;

        case 'tool-searchProducts':
          if (part.state === 'output-available' && part.output) {
            return (
              <div key={part.toolCallId} className="space-y-2">
                {part.output.products.map((product) => (
                  <ProductCard
                    key={product.id}
                    product={product}
                    onCompare={onComparePrice}
                    onViewInCatalog={onViewInCatalog}
                  />
                ))}
                {part.output.products.length === 0 && (
                  <p className="text-sm text-muted-foreground">No products found.</p>
                )}
              </div>
            );
          }
          return <LoadingSpinner key={part.toolCallId} text="Searching catalog..." />;

        case 'tool-comparePrices':
          if (part.state === 'output-available' && part.output) {
            return <ComparisonTable key={part.toolCallId} products={part.output.products} />;
          }
          return <LoadingSpinner key={part.toolCallId} text="Comparing prices..." />;

        case 'tool-suggestCategories':
          if (part.state === 'output-available' && part.output) {
            return (
              <CategoryChips
                key={part.toolCallId}
                suggestions={part.output.suggestions}
                onSelect={onCategorySelect}
              />
            );
          }
          return <LoadingSpinner key={part.toolCallId} text="Finding categories..." />;

        default:
          return null;
      }
    })}
  </div>
))
```

**Key points:**
- MessageBubble is REUSED for text parts - only the outer iteration structure changes
- Tool parts render their own specialized components instead of MessageBubble
- Check `part.state === 'output-available'` before accessing part.output
- Show LoadingSpinner during 'input-streaming' or 'input-available' states
- Reference RESEARCH.md Pattern 3 for part type handling
  </action>
  <verify>
Build passes: `npm run build`
Tool part types handled: `grep -E "tool-searchProducts|tool-comparePrices|tool-suggestCategories" src/components/chat/message-list.tsx`
  </verify>
  <done>
MessageList renders different UI for text vs tool parts, showing ProductCard/ComparisonTable/CategoryChips when tool output is available.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire callbacks from ChatPanel to MessageList</name>
  <files>src/components/chat/chat-panel.tsx</files>
  <action>
Update `src/components/chat/chat-panel.tsx` to provide callback functions to MessageList:

**Add callback handlers:**

```tsx
const handleComparePrice = (productId: string) => {
  sendMessage({ text: `Compare prices for product ${productId}` });
};

const handleCategorySelect = (categoryId: string, categoryName: string) => {
  sendMessage({ text: `Search in category: ${categoryName}` });
};

const handleViewInCatalog = (productId: string) => {
  // For now, just log - full catalog integration is Phase 12
  console.log('View in catalog:', productId);
  // Could open product detail modal or scroll to product in table
};
```

**Pass props to MessageList:**
```tsx
<MessageList
  messages={messages}
  isStreaming={isStreaming}
  onComparePrice={handleComparePrice}
  onCategorySelect={handleCategorySelect}
  onViewInCatalog={handleViewInCatalog}
/>
```

Note: "View in catalog" action is minimal for now - full catalog integration (applying filters to main table) is Phase 12.
  </action>
  <verify>
Build passes: `npm run build`
Callbacks passed to MessageList: `grep -E "onComparePrice|onCategorySelect|onViewInCatalog" src/components/chat/chat-panel.tsx`
  </verify>
  <done>
ChatPanel provides callback handlers for card actions, enabling "Compare prices" button to trigger new AI query and category chips to trigger filtered search.
  </done>
</task>

</tasks>

<verification>
Run full build: `npm run build`
Start dev server: `npm run dev`

Manual test workflow:
1. Open chat widget
2. Type "show me titanium implants"
3. Verify: Product cards appear with name, price, vendor
4. Click expand chevron on a card - verify SKU/material/EMDN appear
5. Click "Compare prices" button - verify comparison table or text appears
6. Type "implants" (broad query)
7. If AI uses suggestCategories: verify EMDN chips appear
8. Click a chip - verify new search message sent

Edge cases:
- "find something not in catalog" -> "No products found" message
- Single-vendor comparison -> text instead of table
</verification>

<success_criteria>
- ProductCard shows compact view with expand toggle
- ProductCard action buttons trigger new chat messages
- ComparisonTable renders single-vendor as text, multi-vendor as sorted table
- CategoryChips render clickable EMDN suggestions
- LoadingSpinner shows during tool execution
- MessageList correctly switches on part.type for all three tools
- Build passes without TypeScript errors
- User can search -> see cards -> compare prices -> see table (full flow)
</success_criteria>

<output>
After completion, create `.planning/phases/09-catalog-search-tools/09-02-SUMMARY.md`
</output>
