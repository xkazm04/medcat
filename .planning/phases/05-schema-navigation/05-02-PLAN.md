---
phase: 05-schema-navigation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/005_category_descendants.sql
  - src/lib/queries.ts
  - src/components/filters/category-tree.tsx
autonomous: true

must_haves:
  truths:
    - "Selecting a parent EMDN category filters products to all descendants"
    - "Category tree shows expand/collapse for navigation"
    - "Selected category path displays as breadcrumb above the tree"
    - "Pagination still works with category filter"
  artifacts:
    - path: "supabase/migrations/005_category_descendants.sql"
      provides: "RPC function for descendant category lookup"
      contains: "get_category_descendants"
    - path: "src/lib/queries.ts"
      provides: "getProducts uses descendant filtering"
      contains: "get_category_descendants"
    - path: "src/components/filters/category-tree.tsx"
      provides: "Category breadcrumb when category selected"
      contains: "EMDNBreadcrumb"
  key_links:
    - from: "src/lib/queries.ts"
      to: "supabase RPC"
      via: "supabase.rpc('get_category_descendants')"
      pattern: "rpc.*get_category_descendants"
    - from: "src/components/filters/category-tree.tsx"
      to: "src/components/product/emdn-breadcrumb.tsx"
      via: "import and render"
      pattern: "EMDNBreadcrumb"
---

<objective>
Enable hierarchical EMDN category filtering so selecting a parent category shows all products in that category and its descendants.

Purpose: With 1000+ products, users need to browse by category hierarchy. Clicking "Orthopaedic devices" should show all subcategory products, not require drilling down to leaf categories.

Output: RPC function for descendant lookup, updated query logic, category breadcrumb in filter UI.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-schema-navigation/05-RESEARCH.md

Key files to modify:
@src/lib/queries.ts
@src/components/filters/category-tree.tsx
@src/components/product/emdn-breadcrumb.tsx (reference for breadcrumb pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RPC function and update queries for descendant filtering</name>
  <files>supabase/migrations/005_category_descendants.sql, src/lib/queries.ts</files>
  <action>
1. Create supabase/migrations/005_category_descendants.sql:

```sql
-- Migration: 005_category_descendants.sql
-- Purpose: Enable filtering products by category and all its descendants
-- Uses path prefix matching on existing emdn_categories.path column

-- Ensure path column has proper index for LIKE prefix queries
CREATE INDEX IF NOT EXISTS idx_emdn_path_pattern
  ON emdn_categories (path text_pattern_ops);

-- RPC function: Get all descendant category IDs for a given category
-- Returns the category itself plus all children (recursive via path prefix)
CREATE OR REPLACE FUNCTION get_category_descendants(parent_category_id UUID)
RETURNS SETOF UUID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  parent_path TEXT;
BEGIN
  -- Get the parent's path
  SELECT path INTO parent_path
  FROM emdn_categories
  WHERE id = parent_category_id;

  IF parent_path IS NULL THEN
    -- Category not found, return just the ID (may still exist without path)
    RETURN QUERY SELECT parent_category_id;
    RETURN;
  END IF;

  -- Return parent category + all descendants (path starts with parent_path/)
  RETURN QUERY
  SELECT id FROM emdn_categories
  WHERE id = parent_category_id  -- The parent itself
     OR path LIKE parent_path || '/%';  -- All descendants
END;
$$;

-- Grant execute permissions
GRANT EXECUTE ON FUNCTION get_category_descendants TO anon, authenticated;
```

2. Update src/lib/queries.ts getProducts function:

Replace the existing category filter block (around line 135-137):
```typescript
// Apply category filter
if (category) {
  query = query.eq("emdn_category_id", category);
}
```

With descendant-aware filtering:
```typescript
// Apply category filter (includes all descendants)
if (category) {
  // Get all descendant category IDs using RPC function
  const { data: categoryIds } = await supabase
    .rpc("get_category_descendants", { parent_category_id: category });

  if (categoryIds && categoryIds.length > 0) {
    query = query.in("emdn_category_id", categoryIds);
  } else {
    // Fallback to exact match if RPC fails
    query = query.eq("emdn_category_id", category);
  }
}
```

Note: The RPC returns UUID[], so categoryIds is already the array of IDs to filter on.
  </action>
  <verify>
1. File exists: supabase/migrations/005_category_descendants.sql
2. grep -n "get_category_descendants" src/lib/queries.ts
   Should show the RPC call in getProducts
3. npm run build passes
  </verify>
  <done>
RPC function created for descendant category lookup.
getProducts uses descendant filtering when category param provided.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add category breadcrumb to CategoryTree component</name>
  <files>src/components/filters/category-tree.tsx</files>
  <action>
The CategoryTree component already has access to:
- categories (the full tree)
- selectedId (from URL search params)

Modify it to show a breadcrumb when a category is selected:

1. Import EMDNBreadcrumb at top:
   import { EMDNBreadcrumb } from '@/components/product/emdn-breadcrumb'

2. Add helper function to find category by ID in the tree (outside the component):
```typescript
function findCategoryById(categories: CategoryNode[], id: string): CategoryNode | null {
  for (const cat of categories) {
    if (cat.id === id) return cat;
    if (cat.children.length > 0) {
      const found = findCategoryById(cat.children, id);
      if (found) return found;
    }
  }
  return null;
}
```

3. In CategoryTree component, derive the selected category:
```typescript
const selectedCategory = selectedId
  ? findCategoryById(categories, selectedId)
  : null;
```

4. Before the existing tree div (the one with space-y-0.5), add breadcrumb conditionally:
```tsx
{selectedCategory && selectedCategory.path && (
  <div className="mb-3 pb-3 border-b border-border">
    <p className="text-xs text-muted-foreground uppercase tracking-wide mb-1.5">
      Filtering
    </p>
    <EMDNBreadcrumb
      path={selectedCategory.path}
      categoryName={selectedCategory.name}
    />
  </div>
)}
```

This shows the full category hierarchy path when a filter is active, helping users understand where they are in the category tree.
  </action>
  <verify>
grep -n "EMDNBreadcrumb" src/components/filters/category-tree.tsx
Should show the import and usage.
npm run build passes.
  </verify>
  <done>
CategoryTree displays breadcrumb above tree when a category is selected.
Users can see the full path of the selected filter category.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes without errors
2. Migration file 005_category_descendants.sql exists with RPC function
3. queries.ts uses get_category_descendants RPC for category filtering
4. category-tree.tsx imports and renders EMDNBreadcrumb when category selected
5. Index created for path column with text_pattern_ops
</verification>

<success_criteria>
- NAV-01: EMDN categories display as collapsible tree (already working, preserved)
- NAV-02: Expand/collapse functionality (already working, preserved)
- NAV-03: Selecting parent category filters to all descendants (new RPC + query logic)
- NAV-04: Current category path shows breadcrumb in filter (new breadcrumb in CategoryTree)
- PERF-02: EMDN tree uses path prefix with proper index (new index + RPC)
</success_criteria>

<output>
After completion, create `.planning/phases/05-schema-navigation/05-02-SUMMARY.md`
</output>
