---
phase: 05-schema-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/004_manufacturer_fields.sql
  - src/lib/types.ts
  - src/lib/schemas/product.ts
  - src/lib/actions/products.ts
  - src/components/product/product-form.tsx
  - src/components/product/product-detail.tsx
autonomous: true

must_haves:
  truths:
    - "Products table has manufacturer_name and manufacturer_sku columns"
    - "Product form shows manufacturer name and manufacturer SKU fields"
    - "Product detail displays manufacturer info when available"
    - "Existing products continue to work (nullable fields)"
  artifacts:
    - path: "supabase/migrations/004_manufacturer_fields.sql"
      provides: "ALTER TABLE adding manufacturer columns with indexes"
      contains: "manufacturer_name"
    - path: "src/lib/types.ts"
      provides: "Product interface with manufacturer fields"
      contains: "manufacturer_name"
    - path: "src/lib/schemas/product.ts"
      provides: "Zod schema with manufacturer validation"
      contains: "manufacturer_name"
    - path: "src/components/product/product-form.tsx"
      provides: "Form inputs for manufacturer fields"
      contains: "manufacturer_name"
    - path: "src/components/product/product-detail.tsx"
      provides: "Display of manufacturer info"
      contains: "manufacturer_name"
  key_links:
    - from: "src/components/product/product-form.tsx"
      to: "src/lib/schemas/product.ts"
      via: "zodResolver(productSchema)"
      pattern: "zodResolver.*productSchema"
    - from: "src/lib/actions/products.ts"
      to: "src/lib/schemas/product.ts"
      via: "productSchema.safeParse"
      pattern: "productSchema\\.safeParse"
---

<objective>
Add manufacturer tracking fields to the products schema and expose them in the UI.

Purpose: Enable tracking of original manufacturer information separate from vendor (supplier). This is critical for the v1.1 bulk import feature which will import manufacturer data from CSV files.

Output: Migration file, updated types/schemas, form with manufacturer fields, detail view showing manufacturer info.
</objective>

<execution_context>
@C:\Users\kazda\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\kazda\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-schema-navigation/05-RESEARCH.md

Key files to modify:
@supabase/migrations/003_similarity_search.sql (reference for migration pattern)
@src/lib/types.ts
@src/lib/schemas/product.ts
@src/lib/actions/products.ts
@src/components/product/product-form.tsx
@src/components/product/product-detail.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create manufacturer fields migration</name>
  <files>supabase/migrations/004_manufacturer_fields.sql</files>
  <action>
Create migration file that adds manufacturer columns to products table:

1. Add columns (nullable, no default for instant operation):
   - manufacturer_name TEXT
   - manufacturer_sku TEXT

2. Add indexes for search performance:
   - Partial index on manufacturer_sku WHERE NOT NULL
   - Trigram GIN index on manufacturer_name for similarity search (pg_trgm already enabled from 003)

3. Include verification query at end to confirm columns exist

Follow the pattern from 003_similarity_search.sql for comments and structure. Use IF NOT EXISTS for idempotent execution.
  </action>
  <verify>
File exists at supabase/migrations/004_manufacturer_fields.sql with:
- ALTER TABLE products ADD COLUMN IF NOT EXISTS manufacturer_name
- ALTER TABLE products ADD COLUMN IF NOT EXISTS manufacturer_sku
- CREATE INDEX statements for both fields
  </verify>
  <done>Migration file ready for manual execution in Supabase SQL Editor</done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types and Zod schema</name>
  <files>src/lib/types.ts, src/lib/schemas/product.ts</files>
  <action>
1. In src/lib/types.ts, add to Product interface (after mdr_class):
   - manufacturer_name: string | null;
   - manufacturer_sku: string | null;

2. In src/lib/schemas/product.ts, add to productSchema (after mdr_class):
   - manufacturer_name: z.string().max(255, "Manufacturer name too long").nullable().optional()
   - manufacturer_sku: z.string().max(100, "Manufacturer SKU too long").nullable().optional()

Ensure field order matches database column order for consistency.
  </action>
  <verify>
grep -n "manufacturer_name" src/lib/types.ts src/lib/schemas/product.ts
Both files should show the new fields.
  </verify>
  <done>TypeScript types and Zod schema include manufacturer_name and manufacturer_sku fields</done>
</task>

<task type="auto">
  <name>Task 3: Add manufacturer fields to form and detail views</name>
  <files>src/lib/actions/products.ts, src/components/product/product-form.tsx, src/components/product/product-detail.tsx</files>
  <action>
1. In src/lib/actions/products.ts:
   - In updateProduct: add manufacturer_name and manufacturer_sku to data object (convert empty string to null like other nullable fields)
   - In createProduct: same additions to data object

2. In src/components/product/product-form.tsx:
   - Add defaultValues for manufacturer_name and manufacturer_sku (from product prop, ?? undefined)
   - Add formData.append for both fields in onSubmit
   - Add two new form fields after the Description field (before Price):

     Manufacturer Name field:
     - Label: "Manufacturer"
     - Input type: text
     - Register as 'manufacturer_name'
     - Use same inputClass styling

     Manufacturer SKU field:
     - Label: "Manufacturer SKU"
     - Input type: text
     - Register as 'manufacturer_sku'
     - Use same inputClass styling

3. In src/components/product/product-detail.tsx:
   - Add new section after "Vendor & Pricing" section (Section 2), before Material:

     Section title: "Manufacturer"
     Grid with 2 columns:
     - Left: "Manufacturer" label + product.manufacturer_name || 'Not specified'
     - Right: "Manufacturer SKU" label + product.manufacturer_sku || 'Not specified'

     Only show this section if at least one manufacturer field has a value.
     Use same styling pattern as Vendor & Pricing section.
  </action>
  <verify>
npm run build (should compile without TypeScript errors)
grep -n "manufacturer" src/components/product/product-form.tsx src/components/product/product-detail.tsx
Both files should show manufacturer field handling.
  </verify>
  <done>
Product form has manufacturer name and SKU input fields.
Product detail shows manufacturer info section when data exists.
Create/update actions handle the new fields.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` passes without errors
2. Migration file exists with correct ALTER TABLE and CREATE INDEX statements
3. types.ts has manufacturer_name and manufacturer_sku in Product interface
4. product.ts schema validates manufacturer fields
5. product-form.tsx has manufacturer input fields
6. product-detail.tsx conditionally displays manufacturer section
7. products.ts actions handle manufacturer fields
</verification>

<success_criteria>
- SCHEMA-01: manufacturer_name column defined in migration
- SCHEMA-02: manufacturer_sku column defined in migration
- SCHEMA-03: Migration uses IF NOT EXISTS (safe to re-run)
- SCHEMA-04: Form and detail views display manufacturer info
- PERF-03: Indexes created for manufacturer fields
</success_criteria>

<output>
After completion, create `.planning/phases/05-schema-navigation/05-01-SUMMARY.md`
</output>
